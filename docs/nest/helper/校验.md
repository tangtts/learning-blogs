# æ ¡éªŒ

## å®‰è£…
```bash
pnpm install class-validator class-transformer
```

## åŸç†

1. class-validator åŒ…æä¾›äº†åŸºäºè£…é¥°å™¨å£°æ˜çš„è§„åˆ™å¯¹å¯¹è±¡åšæ ¡éªŒçš„åŠŸèƒ½
2. class-transformer åˆ™æ˜¯æŠŠä¸€ä¸ªæ™®é€šå¯¹è±¡è½¬æ¢ä¸ºæŸä¸ª class çš„å®ä¾‹å¯¹è±¡çš„

<img src="@backImg/æ ¡éªŒ.png"/>

**æˆ‘ä»¬å£°æ˜äº†å‚æ•°çš„ç±»å‹ä¸º dto ç±»ï¼Œpipe é‡Œæ‹¿åˆ°è¿™ä¸ªç±»ï¼ŒæŠŠå‚æ•°å¯¹è±¡é€šè¿‡ class-transformer è½¬æ¢ä¸º dto ç±»çš„å¯¹è±¡ï¼Œä¹‹åå†ç”¨ class-validator åŒ…æ¥å¯¹è¿™ä¸ªå¯¹è±¡åšéªŒè¯**

```ts
import { PipeTransform, Injectable, ArgumentMetadata, BadRequestException } from '@nestjs/common';
import { validate } from 'class-validator';
import { plainToInstance } from 'class-transformer';

@Injectable()
export class MyValidationPipe implements PipeTransform<any> {
  async transform(value: any, { metatype }: ArgumentMetadata) {
    if (!metatype) {
      return value;
    }
    // æŠŠç”¨æˆ·ä¼ é€’è¿›æ¥çš„æ™®é€šå¯¹è±¡è½¬åŒ–ä¸ºdtoçš„å®ä¾‹
    const object = plainToInstance(metatype, value);
    // æ ¡éªŒå®ä¾‹
    const errors = await validate(object);
    if (errors.length > 0) {
      throw new BadRequestException('å‚æ•°éªŒè¯å¤±è´¥');
    }
    return value;
  }
}
```
pipe é‡Œæ‹¿åˆ°çš„ metatype å°±æ˜¯è¿™éƒ¨åˆ†
<img src="@backImg/æ ¡éªŒ2.webp"/>

## æ ¡éªŒç±»

<blue>æ³¨è§£å™¨æ˜¯ä»ä¸Šåˆ°ä¸‹è¿›è¡Œæ ¡éªŒ</blue>


```ts
async function bootstrap() {
  const app = await NestFactory.create(AppModule);
  app.useGlobalPipes(new ValidationPipe()); // [!code hl]
  await app.listen(3000);
}
bootstrap();
```

1. matches
```ts
  @Matches(/^[a-zA-Z0-9#$%_-]+$/, {
      message: 'ç”¨æˆ·ååªèƒ½æ˜¯å­—æ¯ã€æ•°å­—æˆ–è€… #ã€$ã€%ã€_ã€- è¿™äº›å­—ç¬¦'
  })
```
2. @IsString()
3. @IsNotEmpty()
4. @Length(6, 30)
5. @IsNumberString()  ---  æ•°å­—ç±»å‹çš„å­—ç¬¦ä¸²
6. @IsPhoneNumber("CN") --- ä¸­å›½æ‰‹æœºå·
7. @IsOptional() --- å¯é€‰
8. @IsBoolean() å¸ƒå°”å€¼

### [ğŸ”—å¿½ç•¥](https://docs.nestjs.com/techniques/validation)
å¯ä»¥å¿½ç•¥å‰ç«¯ä¼ è¿›æ¥çš„å¤šä½™å­—æ®µ
```ts
app.useGlobalPipes(
  new ValidationPipe({
    whitelist: true, // [!code hl]
  }),
);
```

### è½¬æ¢
#### transform

> å±€éƒ¨ æ ¡éªŒ
```ts
@Post()
@UsePipes(new ValidationPipe({ transform: true }))
async create(@Body() createCatDto: CreateCatDto) {
  this.catsService.create(createCatDto);
}
```
> å…¨å±€è½¬åŒ–
```ts
app.useGlobalPipes(
  new ValidationPipe({
    transform: true,
  }),
);
```
æ•ˆæœ,å› ä¸ºåœ¨ ç½‘ç»œä¼ è¾“ä¸­ï¼Œæ•°å­—ä¼šè¢«è½¬æ¢æˆå­—ç¬¦ä¸²

```ts
@Get(':id')
findOne(@Param('id') id: number) {
  console.log(typeof id === 'number'); // true
  return 'This action returns a user';
}
```
ä¹Ÿå¯ä»¥ä½¿ç”¨å†…ç½®çš„æ ¡éªŒæ–¹æ³•
```ts
@Get(':id')
findOne(
  @Param('id', ParseIntPipe) id: number,
  @Query('sort', ParseBoolPipe) sort: boolean,
) {
  console.log(typeof id === 'number'); // true
  console.log(typeof sort === 'boolean'); // true
  return 'This action returns a user';
}
```
#### Type 
éœ€è¦ä¸€ä¸ªæ„é€ æ–¹æ³•,æ‰§è¡Œè¿™ä¸ªæ„é€ æ–¹æ³•ï¼Œå°†å€¼è½¬æ¢æˆæƒ³è¦çš„ç±»å‹
```ts
import {  Type,Transform } from 'class-transformer';
export class VerificationCodeDt {
  @IsEnum(PayType)
  // è½¬ç±»å‹
  @Type(() => Number)
  payType: PayType;
}
```

#### Transform
```ts
import {  Type,Transform } from 'class-transformer';
export class VerificationCodeDto {
  @Transform(numberTransformer)
  @IsNumber()
  type: number;
}

export function numberTransformer(params: TransformFnParams) {
  const { value } = params;
  return Number(value);
}
```

### è‡ªå®šä¹‰ç±»å‹

```ts
import { ValidatorConstraint, ValidatorConstraintInterface, ValidationArguments } from "class-validator";


/**
 *
 * @description æ ¡éªŒæ˜¯å¦ä¸€è‡´
 * @example password å’Œ password_confirmed(å¿…é¡»ä»¥_confirmedç»“å°¾)
 * @export
 * @class IsConfirmed
 * @implements {ValidatorConstraintInterface}
 */
@ValidatorConstraint()
export class IsConfirmed implements ValidatorConstraintInterface {
  validate(text: string, args: ValidationArguments) {
    return text === args.object[`${args.property}_confirmed`];
  }

  /** é»˜è®¤é”™è¯¯æ–‡æ¡ˆ */
  defaultMessage(args: ValidationArguments) {
    return "äºŒæ¬¡ç¡®è®¤ä¸ä¸€è‡´";
  }
}
```

ä½¿ç”¨

```ts
export class CreateUserDTO {
  @Validate(IsConfirmed,{message:"ä¸¤æ¬¡å¯†ç ä¸ä¸€è‡´"})
  password:string

  @Length(3,6)
  password_confirmed:string
}
```

### é»˜è®¤å€¼

```ts
export class TodoDTO{
  @IsBoolean()
  isComplated:boolean = false
}
```

## ç±»å‹

```ts
export class CreateCatDto {
  name: string;
  age: number;
  breed: string;
}
```
### PartialType
```ts
export class UpdateCatDto extends PartialType(CreateCatDto) {}
```
### PickType
```ts
export class UpdateCatAgeDto extends PickType(CreateCatDto, ['age'] as const) {}
```
### OmitType
```ts
export class UpdateCatDto extends OmitType(CreateCatDto, ['name'] as const) {}
```
### IntersectionType
```ts
export class CreateCatDto {
  name: string;
  breed: string;
}

export class AdditionalCatInfo {
  color: string;
}
```
åˆå¹¶ä¸¤ä¸ªç±»å‹

```ts
export class UpdateCatDto extends IntersectionType(
  CreateCatDto,
  AdditionalCatInfo,
) {}
```
### è”åˆç±»å‹

```ts
export class UpdateCatDto extends PartialType(
  OmitType(CreateCatDto, ['name'] as const),
) {}
```